<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C-TDS Pace Calculator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Handjet:wght@300;400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,200..700,0..1,-50..200"/>
    <style>
        :root {
            /* Canvas */
            --frame-width: 393px;
            --frame-height: 852px;
            --safe-padding-top: 24px;
            --safe-padding-right: 24px;
            --safe-padding-bottom: 16px;
            --safe-padding-left: 24px;

            /* Colors */
            --color-bg: #C20707;
            --color-text: #FFF;
            --color-border: #FFF;
            --color-active-circle-fill: #FFF;
            --color-active-circle-label: #C20707;

            /* Opacity */
            --opacity-target: 1;
            --opacity-nontarget: 0.4;

            /* Fixed sizes (objects never shrink) */
            --font-family: "Handjet", system-ui, sans-serif;
            --font-weight-default: 400;
            --font-size-display: 84px;
            --font-size-title: 36px;
            --font-size-label: 20px;
            --font-size-button: 20px;
            --toggle-h: 48px;
            --circle-d: 104px;
            --label-value-gap: 12px;
            --time-top-offset: 24px;
            --toggles-to-circles: 12px;     /* footer rows closer */
            --circles-bottom: 8px;          /* less air at very bottom */
            --reset-gap: 12px;              /* gap above reset row */
            --reset-h: 32px;                /* visual height of reset row */
            --line-height-display: normal;
            --line-height-label: normal;
            --line-height-button: normal;
            --letter-spacing-display: 0;
            --letter-spacing-label: 0;
            --letter-spacing-button: 0;
            --label-left: 24px;
            --value-right: 24px;
            --toggle-mx: 0px;
            --toggle-gap: 0px;
            --toggle-bw: 1px;
            --toggle-br: 0px;
            --toggle-px: 12px;
            --toggle-py: 8px;
            --circle-stroke: 1px;

            /* Footer height = toggles + gap + circles + gap + reset + bottom safe area */
            --footer-h: calc(
                var(--toggle-h) + var(--toggles-to-circles) + var(--circle-d) +
                var(--reset-gap) + var(--reset-h) + var(--circles-bottom) +
                env(safe-area-inset-bottom, 0)
            );

            /* One field block's fixed height (label + gap + big number) */
            --block-h: calc(var(--font-size-label) + var(--label-value-gap) + var(--font-size-display));

            /* Total fixed stack (no inter-block gaps) */
            --stack-fixed: calc(
                var(--time-top-offset) + (4 * var(--block-h)) + var(--footer-h) +
                var(--safe-padding-top) + var(--safe-padding-bottom)
            );

            /* Remaining height available for the four gaps */
            --available: calc(min(100dvh, var(--frame-height)) - var(--stack-fixed));

            /* Dynamic gap: share leftover evenly across 4 gaps, cap tighter at 8px */
            --gap-dynamic: clamp(0px, calc(var(--available) / 4), 8px);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            font-weight: var(--font-weight-default);
            background-color: var(--color-bg);
            color: var(--color-text);
            min-height: auto;
            padding: env(safe-area-inset-top, 0) env(safe-area-inset-right, 0) env(safe-area-inset-bottom, 0) env(safe-area-inset-left, 0);
        }

        .ctds-app {
            width: 100%;
            max-width: var(--frame-width);
            height: min(100dvh, var(--frame-height));
            max-height: var(--frame-height);
            overflow: hidden;
            margin: 0 auto;
            padding: var(--safe-padding-top) var(--safe-padding-right) var(--safe-padding-bottom) var(--safe-padding-left);
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .ctds-header {
            font-size: var(--font-size-title);
            font-weight: var(--font-weight-default);
            text-transform: uppercase;
            letter-spacing: var(--letter-spacing-label);
            line-height: var(--line-height-label);
        }

        .ctds-main { 
            flex: 1 1 auto;
            display: flex;
            flex-direction: column;
            min-height: 0;
            padding-bottom: var(--footer-h);
        }

        .ctds-controls {
            padding-bottom: calc(var(--circles-bottom) + env(safe-area-inset-bottom, 0));
        }

        .ctds-header, .ctds-field, .ctds-controls { 
            flex-shrink: 0; 
        }

        .ctds-field{
            display:flex;
            justify-content:flex-end;   /* values hug right rail */
            align-items:baseline;       /* 20px label + 84px value share baseline */
            gap:12px;                   /* spec gap */
            min-width:0;                /* iOS Safari flex-shrink fix */
            padding: 0;
        }

        .ctds-field--time {
            margin-top: var(--time-top-offset);
            margin-bottom: var(--gap-dynamic);
        }

        .ctds-field--distance {
            margin-bottom: var(--gap-dynamic);
        }


        .ctds-field--speed {
            margin-bottom: var(--gap-dynamic);
        }

        .ctds-label{
            font-size: var(--font-size-label);
            font-weight: var(--font-weight-default);
            text-transform: uppercase;
            letter-spacing: var(--letter-spacing-label);
            line-height: 1;
            position: relative; top: 1px;   /* Handjet baseline nudge */
            white-space: nowrap;
            margin-left: var(--label-left);
            margin-bottom: 0;
        }

        .ctds-value{
            font-family: var(--font-family);
            font-size: var(--font-size-display);
            font-weight: var(--font-weight-default);
            letter-spacing: var(--letter-spacing-display);
            line-height: 1;
            text-align: right;
            direction: ltr;
            margin-right: 0px;
            background: transparent;
            border: none;
            color: var(--color-text);
            outline: none;
            /* Flex row sizing: hug content, never spill the rail */
            flex: 0 1 auto;
            min-width: 0;           /* iOS Safari shrink fix */
            max-width: 100%;
            width: auto;            /* kill previous width hacks */
            font-variant-numeric: tabular-nums;
            padding-inline-end: 0.1ch;  /* caret safety */
            overflow: hidden;           /* guard sub‑px spill */
        }

        .ctds-value::placeholder {
            color: var(--color-text);
            opacity: 0.6;
        }

        .ctds-value:focus {
            outline: 2px solid rgba(255, 255, 255, 0.3);
            outline-offset: 2px;
        }

        .ctds-field.is-target .ctds-value {
            opacity: var(--opacity-target);
            cursor: not-allowed;
        }

        .ctds-field.is-nontarget .ctds-value {
            opacity: var(--opacity-nontarget);
        }

        .ctds-toggle-row {
            display: flex;
            margin: 0 var(--toggle-mx);
            margin-bottom: var(--toggles-to-circles);
            gap: var(--toggle-gap);
        }

        .ctds-toggle {
            flex: 1;
            height: var(--toggle-h);
            background: transparent;
            border: var(--toggle-bw) solid var(--color-border);
            border-radius: var(--toggle-br);
            color: var(--color-text);
            font-family: var(--font-family);
            font-size: var(--font-size-button);
            font-weight: var(--font-weight-default);
            text-transform: uppercase;
            letter-spacing: var(--letter-spacing-button);
            line-height: var(--line-height-button);
            padding: var(--toggle-py) var(--toggle-px);
            cursor: pointer;
            transition: background-color 0.2s ease;
            min-width: 48px;
            min-height: 48px;
        }

        .ctds-toggle:focus {
            outline: 2px solid rgba(255, 255, 255, 0.8);
            outline-offset: 2px;
        }

        .ctds-toggle:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .ctds-toggle:active {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .ctds-circles {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 0 var(--toggle-mx);
        }

        .ctds-circle {
            width: var(--circle-d);
            height: var(--circle-d);
            border-radius: 50%;
            border: var(--circle-stroke) solid var(--color-border);
            background: transparent;
            color: var(--color-text);
            font-family: var(--font-family);
            font-size: var(--font-size-button);
            font-weight: var(--font-weight-default);
            text-transform: uppercase;
            letter-spacing: var(--letter-spacing-button);
            line-height: var(--line-height-button);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            min-width: 48px;
            min-height: 48px;
        }

        .ctds-circle:focus {
            outline: 2px solid rgba(255, 255, 255, 0.8);
            outline-offset: 2px;
        }

        .ctds-circle:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .ctds-circle.is-active {
            background-color: var(--color-active-circle-fill);
            color: var(--color-active-circle-label);
        }

        @supports (position: sticky) {
            .ctds-controls { 
                position: sticky; 
                bottom: env(safe-area-inset-bottom, 0); 
            }
        }

        @supports not (height: 100dvh) {
            .ctds-app { height: min(100vh, var(--frame-height)); }
            :root { --available: calc(min(100vh, var(--frame-height)) - var(--stack-fixed)); }
        }

        /* Remove default focus rings on pills/circles, but keep them for keyboards via :focus-visible */
        .ctds-toggle:focus,
        .ctds-circle:focus { 
            outline: none; 
        }
        .ctds-toggle:focus-visible,
        .ctds-circle:focus-visible {
            outline: 1px solid rgba(255,255,255,.75);
            outline-offset: 2px;
        }

        /* widen the frame on desktop, keep mobile spec */
        :root { --frame-width: clamp(393px, 92vw, 448px); }

        /* Add field spacing back */
        .ctds-field--time {
            margin-top: var(--time-top-offset);
            margin-bottom: var(--gap-dynamic);
        }

        .ctds-field--distance {
            margin-bottom: var(--gap-dynamic);
        }

        .ctds-field--speed {
            margin-bottom: var(--gap-dynamic);
        }

        .ctds-field--pace {
            margin-bottom: var(--gap-dynamic);
        }

        /* Toggle row borders: 2-button layout */
        .ctds-toggle-row .ctds-toggle{ border:1px solid #FFF; }
        .ctds-toggle-row .ctds-toggle + .ctds-toggle{
            border-left:none; box-shadow: inset 1px 0 0 0 #FFF;
        }

        /* --- Safety neutralizers --- */
        .ctds-field{ grid-template-columns: unset !important; }
        .ctds-field .ctds-value{ width: auto !important; }

        /* --- Footer layout: stack on mobile, spread on wide --- */

        /* 1) make the footer itself a flex container with a vertical stack by default */
        .ctds-controls{
            display:flex;
            flex-direction:column;
            gap: var(--toggles-to-circles);     /* keep your 24px token */
            padding-inline: var(--toggle-mx);   /* same 24px side insets */
        }

        /* 2) make each inner block flex nicely */
        .ctds-toggle-row,
        .ctds-circles{
            flex: 1 1 auto;     /* allows them to grow/shrink */
            margin-inline: 0;   /* kill previous inline margins so flex can rule */
            width: auto;
        }

        /* keep existing behavior inside each row */
        .ctds-toggle-row{ display:flex; }
        .ctds-circles{ display:flex; justify-content: space-between; align-items:center; }


        /* Footer stays stacked: toggles row on top, circles on bottom, full width */
        .ctds-controls{ flex-direction: column; }
        .ctds-toggle-row, .ctds-circles{ width: 100%; }
        .ctds-toggle-row .ctds-toggle{ flex: 1 1 0; }

        /* Pin footer to bottom on mobile and desktop */
        .ctds-app { position: relative; }
        .ctds-controls {
            position: absolute;
            left: var(--safe-padding-left);
            right: var(--safe-padding-right);
            bottom: env(safe-area-inset-bottom, 0);
        }

        /* Distance value box: compact, stable width ~ just enough for 99.99 */
        .ctds-field--distance > .ctds-value{
            inline-size: 5ch !important;     /* approx width for 99.99 */
            max-inline-size: 100%;
        }

        /* Speed value box: compact, stable width for MM:SS or 00.00 */
        .ctds-field--speed > .ctds-value{
            inline-size: 5ch !important;
            max-inline-size: 100%;
        }

        /* Time value box: compact, stable width for HH:MM:SS */
        .ctds-field--time > .ctds-value{
            inline-size: 7.5ch !important;   /* fits 00:00:00 comfortably */
            max-inline-size: 100%;
        }

        /* Pace value box: compact, stable width for MM:SS */
        .ctds-field--pace > .ctds-value{
            inline-size: 5ch !important;     /* fits 00:00 comfortably */
            max-inline-size: 100%;
        }

        /* Reset button styling */
        .ctds-reset {
            margin-top: var(--reset-gap);
            display: flex;
            justify-content: flex-start;
        }

        .ctds-reset-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            background: transparent;
            border: none;
            color: var(--color-text);
            font-family: var(--font-family);
            font-size: var(--font-size-button);
            font-weight: var(--font-weight-default);
            text-transform: uppercase;
            letter-spacing: var(--letter-spacing-button);
            line-height: var(--line-height-button);
            cursor: pointer;
            transition: opacity 0.2s ease;
            padding: 8px 0;
            min-height: var(--reset-h);
        }

        .ctds-reset-btn:hover {
            opacity: 0.7;
        }

        .ctds-reset-btn:focus { outline: none; }
        .ctds-reset-btn:focus-visible {
            outline: 1px solid rgba(255,255,255,.75);
            outline-offset: 2px;
        }

        .ctds-reset .material-symbols-outlined {
            font-size: 20px;
            line-height: 1;
        }

        /* Toggle button active states */
        .ctds-toggle.is-active {
            background-color: var(--color-active-circle-fill);
            color: var(--color-active-circle-label);
        }

        /* Label colors */
        .ctds-field--distance .ctds-label,
        .ctds-field--speed .ctds-label,
        .ctds-field--pace .ctds-label{ color:#FFC7C7; }

        /* High-contrast user preference: ensure sufficient contrast for pink labels */
        @media (prefers-contrast: more){
            .ctds-field--distance .ctds-label,
            .ctds-field--speed .ctds-label,
            .ctds-field--pace .ctds-label { color:#FFF; }
        }
    </style>
</head>
<body>
    <div class="ctds-app">
        <header class="ctds-header">C-TDS</header>
        
        <main class="ctds-main">
            <div class="ctds-field ctds-field--time is-target">
                <label class="ctds-label" for="timeInput" id="timeLabel">HH:MM:SS</label>
                <input type="text" 
                       class="ctds-value" 
                       id="timeInput" 
                       placeholder="00:00:00"
                       aria-describedby="timeLabel"
                       aria-disabled="true">
            </div>

            <div class="ctds-field ctds-field--distance is-nontarget">
                <label class="ctds-label" for="distanceInput" id="distanceLabel">KM</label>
                <input type="text" 
                       class="ctds-value" 
                       id="distanceInput" 
                       placeholder="00.00"
                       aria-describedby="distanceLabel"
                       inputmode="decimal">
            </div>

            <div class="ctds-field ctds-field--speed is-nontarget">
                <label class="ctds-label" for="speedInput" id="speedLabel">KM/H</label>
                <input type="text" 
                       class="ctds-value" 
                       id="speedInput" 
                       placeholder="00.00"
                       aria-describedby="speedLabel"
                       inputmode="decimal">
            </div>

            <div class="ctds-field ctds-field--pace is-nontarget">
                <label class="ctds-label" for="paceInput" id="paceLabel">MIN/KM</label>
                <input type="text" 
                       class="ctds-value" 
                       id="paceInput" 
                       placeholder="00:00"
                       aria-describedby="paceLabel"
                       inputmode="numeric">
            </div>
        </main>

        <footer class="ctds-controls">
            <div class="ctds-toggle-row">
                <button class="ctds-toggle" id="unitToggle">METRIC</button>
                <button class="ctds-toggle" id="imperialToggle">IMPERIAL</button>
            </div>

            <div class="ctds-circles">
                <button class="ctds-circle is-active" id="timeBtn" aria-pressed="true">TIME</button>
                <button class="ctds-circle" id="distanceBtn" aria-pressed="false">DISTANCE</button>
                <button class="ctds-circle" id="speedBtn" aria-pressed="false">SPEED</button>
            </div>

            <div class="ctds-reset">
                <button class="ctds-reset-btn" id="resetBtn">
                    <span class="material-symbols-outlined" aria-hidden="true">restart_alt</span>
                    <span class="ctds-reset-text">RESET</span>
                </button>
            </div>
        </footer>

        <div id="ann" role="status" style="position:absolute;left:-9999px;"></div>
    </div>

    <script>
        class PaceCalculator {
            constructor() {
                this.target = 'TIME';
                this.unitSystem = 'METRIC';
                this.computeTimeout = null;
                this.lastEdited = 'PACE';
                
                this.init();
                this.loadState();
                this.attachEventListeners();
                this.updateUI();
            }

            init() {
                this.timeInput = document.getElementById('timeInput');
                this.distanceInput = document.getElementById('distanceInput');
                this.speedInput = document.getElementById('speedInput');
                this.paceInput = document.getElementById('paceInput');
                
                this.distanceLabel = document.getElementById('distanceLabel');
                this.speedLabel = document.getElementById('speedLabel');
                this.paceLabel = document.getElementById('paceLabel');
                
                this.unitToggle = document.getElementById('unitToggle');
                this.imperialToggle = document.getElementById('imperialToggle');
                this.resetBtn = document.getElementById('resetBtn');
                
                this.timeBtn = document.getElementById('timeBtn');
                this.distanceBtn = document.getElementById('distanceBtn');
                this.speedBtn = document.getElementById('speedBtn');
            }

            attachEventListeners() {
                [this.timeInput, this.distanceInput, this.speedInput, this.paceInput].forEach(input => {
                    input.addEventListener('input', () => {
                        if (input === this.paceInput) this.lastEdited = 'PACE';
                        if (input === this.speedInput) this.lastEdited = 'SPEED';
                        this.debouncedCompute();
                    });
                    input.addEventListener('blur', () => this.handleBlur(input));
                });

                this.unitToggle.addEventListener('click', () => this.setUnitSystem('METRIC'));
                this.imperialToggle.addEventListener('click', () => this.setUnitSystem('IMPERIAL'));
                // Click clears values, long-press (>=500ms) does factory reset
                let pressTimer = null;
                const startPress = () => {
                    clearTimeout(pressTimer);
                    pressTimer = setTimeout(() => this.factoryReset(), 500);
                };
                const cancelPress = () => {
                    if (pressTimer) {
                        clearTimeout(pressTimer);
                        pressTimer = null;
                    }
                };
                this.resetBtn.addEventListener('mousedown', startPress);
                this.resetBtn.addEventListener('touchstart', startPress, { passive: true });
                this.resetBtn.addEventListener('mouseup', () => {
                    if (pressTimer) { cancelPress(); this.clear(); }
                });
                this.resetBtn.addEventListener('touchend', () => {
                    if (pressTimer) { cancelPress(); this.clear(); }
                });
                this.resetBtn.addEventListener('mouseleave', cancelPress);

                this.timeBtn.addEventListener('click', () => this.setTarget('TIME'));
                this.distanceBtn.addEventListener('click', () => this.setTarget('DISTANCE'));
                this.speedBtn.addEventListener('click', () => this.setTarget('SPEED'));
            }

            debouncedCompute() {
                clearTimeout(this.computeTimeout);
                this.computeTimeout = setTimeout(() => this.compute(), 200);
            }

            handleBlur(input) {
                clearTimeout(this.computeTimeout);
                
                // Apply digits-to-timestamp conversion before normalization (blur-only)
                const raw = input.value.trim();
                
                if (input === this.timeInput) {
                    const auto = this.parseDigitsToTime(raw);
                    if (auto) input.value = auto;
                } else if (input === this.paceInput) {
                    const auto = this.parseDigitsToPace(raw);
                    if (auto) input.value = auto;
                }
                
                this.normalizeInput(input);
                this.compute();
                this.saveState();
            }

            parseDigitsToPace(val) {
                if (!/^\d+$/.test(val)) return null;
                const digits = val.padStart(2,"0").slice(-4); // keep last up to 4
                const m = digits.slice(0, Math.max(0, digits.length - 2)) || "0";
                const s = digits.slice(-2);
                return `${String(parseInt(m)||0).padStart(2,'0')}:${String(parseInt(s)||0).padStart(2,'0')}`;
            }

            parseDigitsToTime(val) {
                if (!/^\d+$/.test(val)) return null;
                const digits = val.padStart(2,"0").slice(-6); // keep last up to 6
                const h = digits.slice(0, Math.max(0, digits.length - 4)) || "0";
                const m = digits.slice(-4, -2) || "0";
                const s = digits.slice(-2) || "0";
                return `${String(parseInt(h)||0).padStart(2,'0')}:${String(parseInt(m)||0).padStart(2,'0')}:${String(parseInt(s)||0).padStart(2,'0')}`;
            }

            normalizeInput(input) {
                let value = input.value.trim();
                if (!value) return;

                if (input === this.timeInput) {
                    value = this.normalizeTime(value);
                } else if (input === this.distanceInput) {
                    value = this.normalizeDistance(value);
                } else if (input === this.speedInput) {
                    value = this.normalizeVelocity(value);
                } else if (input === this.paceInput) {
                    value = this.normalizePace(value);
                }
                
                input.value = value;
            }

            normalizeTime(timeStr) {
                const parts = timeStr.split(':').map(p => parseInt(p) || 0);
                
                if (parts.length === 1) {
                    parts.unshift(0, 0);
                } else if (parts.length === 2) {
                    parts.unshift(0);
                }
                
                let [h, m, s] = parts;
                
                if (s >= 60) {
                    m += Math.floor(s / 60);
                    s = s % 60;
                }
                if (m >= 60) {
                    h += Math.floor(m / 60);
                    m = m % 60;
                }
                
                h = Math.min(99, Math.max(0, h));
                m = Math.min(59, Math.max(0, m));
                s = Math.min(59, Math.max(0, s));
                
                return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            }

            normalizeDistance(distStr) {
                distStr = (distStr || '').replace(',', '.');
                let dist = parseFloat(distStr) || 0;
                dist = Math.min(99.99, Math.max(0, dist));
                return dist.toFixed(2);
            }

            normalizePace(paceStr) {
                const parts = paceStr.split(':').map(p => parseInt(p) || 0);
                let [m, s] = parts.length === 2 ? parts : [parseInt(paceStr) || 0, 0];
                
                if (s >= 60) {
                    m += Math.floor(s / 60);
                    s = s % 60;
                }
                
                if (m > 20 || (m === 20 && s > 59)) {
                    m = 20;
                    s = 59;
                }
                
                m = Math.max(0, m);
                s = Math.max(0, s);
                
                return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            }

            normalizeVelocity(velStr) {
                velStr = (velStr || '').replace(',', '.');
                let vel = parseFloat(velStr) || 0;
                vel = Math.min(99.99, Math.max(0, vel));
                return vel.toFixed(2);
            }

            setTarget(newTarget) {
                this.target = newTarget;
                this.updateUI();
                this.saveState();
            }

            setUnitSystem(newSystem) {
                const old = this.unitSystem;
                this.unitSystem = newSystem;
                this.convertUnits(old, this.unitSystem);
                this.updateUI();
                this.saveState();
                this.compute();
            }

            convertUnits(fromSystem, toSystem) {
                const CF = 1.609344;

                if (this.distanceInput.value) {
                    let d = parseFloat(this.distanceInput.value) || 0;
                    if (fromSystem==='METRIC' && toSystem==='IMPERIAL') d /= CF;
                    else if (fromSystem==='IMPERIAL' && toSystem==='METRIC') d *= CF;
                    this.distanceInput.value = Math.min(99.99, d).toFixed(2);
                }

                if (this.speedInput.value) {
                    let v = parseFloat(this.speedInput.value) || 0;
                    if (fromSystem==='METRIC' && toSystem==='IMPERIAL') v /= CF;
                    else if (fromSystem==='IMPERIAL' && toSystem==='METRIC') v *= CF;
                    this.speedInput.value = Math.min(99.99, v).toFixed(2);
                }

                if (this.paceInput.value) {
                    const [mm, ss] = this.paceInput.value.split(':').map(n=>parseInt(n)||0);
                    let total = mm*60 + ss;
                    if (fromSystem==='METRIC' && toSystem==='IMPERIAL') total *= CF;
                    else if (fromSystem==='IMPERIAL' && toSystem==='METRIC') total /= CF;
                    this.paceInput.value = this.normalizePace(`${Math.floor(total/60)}:${Math.round(total%60)}`);
                }
            }

            clear() {
                this.timeInput.value = '';
                this.distanceInput.value = '';
                this.speedInput.value = '';
                this.paceInput.value = '';

                this.updateUI();
                this.saveState();
            }

            factoryReset() {
                this.timeInput.value = '';
                this.distanceInput.value = '';
                this.speedInput.value = '';
                this.paceInput.value = '';
                this.target = 'TIME';
                this.unitSystem = 'METRIC';
                this.updateUI();
                this.saveState();
            }

            updateUI() {
                document.querySelectorAll('.ctds-field').forEach(field => {
                    field.classList.remove('is-target', 'is-nontarget');
                });
                
                const targetField = document.querySelector(`.ctds-field--${this.target.toLowerCase()}`);
                targetField.classList.add('is-target');
                
                document.querySelectorAll('.ctds-field').forEach(field => {
                    if (!field.classList.contains('is-target')) {
                        field.classList.add('is-nontarget');
                    }
                });
                
                [this.timeInput, this.distanceInput, this.speedInput, this.paceInput].forEach(input => {
                    const isTarget = input.closest('.ctds-field').classList.contains('is-target');
                    input.disabled = isTarget;
                    input.setAttribute('aria-disabled', isTarget.toString());
                });
                
                // Update labels based on unit system
                this.distanceLabel.textContent = this.unitSystem === 'METRIC' ? 'KM' : 'MI';
                this.speedLabel.textContent = this.unitSystem === 'METRIC' ? 'KM/H' : 'MPH';
                this.paceLabel.textContent = this.unitSystem === 'METRIC' ? 'MIN/KM' : 'MIN/MI';
                
                // Set input modes and patterns
                this.timeInput.setAttribute('inputmode', 'numeric');
                this.timeInput.setAttribute('pattern', '\\d{1,2}:\\d{2}:\\d{2}');
                
                this.distanceInput.setAttribute('inputmode', 'decimal');
                this.distanceInput.removeAttribute('pattern');
                
                this.speedInput.setAttribute('inputmode', 'decimal');
                this.speedInput.removeAttribute('pattern');
                
                this.paceInput.setAttribute('inputmode', 'numeric');
                this.paceInput.setAttribute('pattern', '\\d{1,2}:\\d{2}');
                
                // Update toggle button states
                this.unitToggle.classList.toggle('is-active', this.unitSystem === 'METRIC');
                this.imperialToggle.classList.toggle('is-active', this.unitSystem === 'IMPERIAL');
                
                [this.timeBtn, this.distanceBtn, this.speedBtn].forEach(btn => {
                    btn.classList.remove('is-active');
                    btn.setAttribute('aria-pressed', 'false');
                });
                
                const activeBtn = document.getElementById(`${this.target.toLowerCase()}Btn`);
                activeBtn.classList.add('is-active');
                activeBtn.setAttribute('aria-pressed', 'true');
            }

            compute() {
                const timeStr = this.timeInput.value;
                const distanceStr = this.distanceInput.value;
                const speedStr = this.speedInput.value;
                const paceStr = this.paceInput.value;
                
                const time = this.parseTime(timeStr);
                const distance = parseFloat(distanceStr) || 0;
                const speed = parseFloat(speedStr) || 0;
                const pace = this.parsePace(paceStr);
                
                const hasV = speed > 0, hasP = pace > 0;
                const pickPace  = (hasP && !hasV) || (hasP && hasV && this.lastEdited==='PACE');
                const pickSpeed = (hasV && !hasP) || (hasP && hasV && this.lastEdited==='SPEED');
                
                if (this.target === 'TIME') {
                    if (distance > 0) {
                        if (pickSpeed) {
                            // Calculate from speed: time = distance / speed
                            const result = (distance / speed) * 3600;
                            this.timeInput.value = this.formatTime(result);
                        } else if (pickPace) {
                            // Calculate from pace: time = distance * pace
                            const result = distance * pace;
                            this.timeInput.value = this.formatTime(result);
                        }
                    }
                } else if (this.target === 'DISTANCE') {
                    if (time > 0) {
                        if (pickSpeed) {
                            // Calculate from speed: distance = speed * (time / 3600)
                            const result = speed * (time / 3600);
                            this.distanceInput.value = Math.min(99.99, result).toFixed(2);
                        } else if (pickPace) {
                            // Calculate from pace: distance = time / pace
                            const result = time / pace;
                            this.distanceInput.value = Math.min(99.99, result).toFixed(2);
                        }
                    }
                } else if (this.target === 'SPEED') {
                    if (time > 0 && distance > 0) {
                        const vNew = distance / (time / 3600);
                        const pNew = time / distance;
                        this.speedInput.value = Math.min(99.99, vNew).toFixed(2);
                        this.paceInput.value  = this.formatPace(pNew);
                    }
                }

                // --- keep speed/pace in sync when time & distance are known ---
                {
                    const tNow = this.parseTime(this.timeInput.value);
                    const dNow = parseFloat(this.distanceInput.value) || 0;

                    if (tNow > 0 && dNow > 0) {
                        const vNew = dNow / (tNow / 3600); // units/hour
                        const pNew = tNow / dNow;          // sec/unit

                        const hasSpeed = !!(parseFloat(this.speedInput.value) || 0);
                        const hasPace  = !!this.parsePace(this.paceInput.value);

                        if (this.lastEdited === 'PACE') {
                            // user is driving with pace; back-fill speed
                            this.speedInput.value = Math.min(99.99, vNew).toFixed(2);
                        } else if (this.lastEdited === 'SPEED') {
                            // user is driving with speed; back-fill pace
                            this.paceInput.value = this.formatPace(pNew);
                        } else {
                            // neither explicitly “last touched”: fill whichever is empty, or both
                            if (!hasSpeed) this.speedInput.value = Math.min(99.99, vNew).toFixed(2);
                            if (!hasPace)  this.paceInput.value  = this.formatPace(pNew);
                        }
                    }
                }

                const ann = document.getElementById('ann');
                if (ann) {
                    const prev = this._lastAnn || '';
                    const msg = `Updated: time ${this.timeInput.value || '—'}, distance ${this.distanceInput.value || '—'}, speed ${this.speedInput.value || '—'}, pace ${this.paceInput.value || '—'}`;
                    if (msg !== prev) { ann.textContent = msg; this._lastAnn = msg; }
                }
                
                this.saveState();
            }

            parseTime(timeStr) {
                if (!timeStr) return 0;
                const parts = timeStr.split(':').map(p => parseInt(p) || 0);
                if (parts.length === 3) {
                    const [h, m, s] = parts;
                    return h * 3600 + m * 60 + s;
                }
                return 0;
            }

            parsePace(paceStr) {
                if (!paceStr) return 0;
                const parts = paceStr.split(':').map(p => parseInt(p) || 0);
                if (parts.length === 2) {
                    const [m, s] = parts;
                    return m * 60 + s;
                }
                return 0;
            }

            formatTime(seconds) {
                let h = Math.floor(seconds/3600);
                let m = Math.floor((seconds%3600)/60);
                let s = Math.round(seconds%60);
                if (s === 60) { s = 0; m += 1; }
                if (m === 60) { m = 0; h += 1; }
                h = Math.min(99, h);
                return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
            }

            formatPace(seconds) {
                let m = Math.floor(seconds/60);
                let s = Math.round(seconds%60);
                if (s === 60) { s = 0; m += 1; }
                if (m > 20 || (m === 20 && s > 59)) { m = 20; s = 59; }
                return `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
            }

            saveState() {
                const state = {
                    target: this.target,
                    unitSystem: this.unitSystem,
                    values: {
                        time: this.timeInput.value,
                        distance: this.distanceInput.value,
                        speed: this.speedInput.value,
                        pace: this.paceInput.value
                    }
                };
                localStorage.setItem('pace-calculator-state', JSON.stringify(state));
            }

            loadState() {
                try {
                    const saved = localStorage.getItem('pace-calculator-state');
                    if (saved) {
                        const state = JSON.parse(saved);
                        this.target = state.target || 'TIME';
                        this.unitSystem = state.unitSystem || 'METRIC';
                        
                        if (state.values) {
                            if (state.values.time) this.timeInput.value = state.values.time;
                            if (state.values.distance) this.distanceInput.value = state.values.distance;
                            if (state.values.speed) this.speedInput.value = state.values.speed;
                            if (state.values.pace) this.paceInput.value = state.values.pace;
                        }
                    }
                } catch (e) {
                    // Use defaults
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            new PaceCalculator();
        });
    </script>
</body>
</html>